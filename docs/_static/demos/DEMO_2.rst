Demo: WER and normalization
============================

In this step-by-step demo you will compare the Word Error Rate (WER) of two machine-generated transcripts. The WER is calculated against a less-than-perfect reference made from a human-generated subtitle file. You will also use normalization rules to improve the accuracy of the results.

To run this demo you will need a working installation of ``benchmarkstt`` and these source files saved to your working folder:

* `Subtitle file <_static/demos/qt_subs.xml>`_
* `Transcript generated by AWS <_static/demos/qt_aws.json>`_ 
* `Transcript generated by Kaldi <_static/demos/qt_kaldi.json>`_ 

This demo shows the capabilities of version 1 of the library, which benchmarks the accuracy of word recognition only. The library supports adding new metrics in future releases. Contributions are welcome. 

Make the "reference"
--------------------

Creating accurate verbatim transcripts for use as reference is time-consuming and expensive. As a quick and easy alternative, we will make a "reference" from a subtitles file. Subtitles are slightly edited and they include additional text like descriptions of sounds and actions, so they are not a verbatim transcription of the speech. Consequently, they are not suitable for calculating absolute WER. However, we are interested in calculating relative WER for illustration purposes only, so this use of subtitles is deemed acceptable. 

.. warning:: 
	This is a demo of work in progress. The benchmarking tool is still in development and evaluations are not done for the purpose of assessing tools. In addition, the use of subtitles as reference will skew the results so they should not be taken as an indication of overall performance or as an endorsement of a particular vendor or engine.

We will use the subtitles file for the BBC's Question Time Brexit debate. This program was chosen for its length (90 minutes) and because live debates are particularly challenging to transcribe.

The subtitles file includes a lot of extra text in XML tags. This text shouldn't be used in the calculation: for both reference and hypotheses, we want to run the tool on plain text only. To strip out the XML tags, we will use the :code:`benchmarkstt-tools` command, with the :code:`normalization` subcommand:  


.. code:: bash

	benchmarkstt-tools normalization --in qt_subs.xml --out qt_reference.txt --regex "<[^>]+>" " "

The normalization rule :code:`--regex` takes two parameters: a regular expression pattern and the replacement string. In this case all XML tags will be replaced with a space. This will result in a lot of space characters, but these are ignored by the diff algorithm later so we don't have to clean these up. :code:`--in` and :code:`--out` are the input and output files. 

The file :code:`qt_reference.txt` has been created. You can see that the XML tags are gone, but the file still contains non-dialogue text like 'APPLAUSE'. For better results you can manually clean up the text, or run the command again with a different normalization rule (not included in this demo). But we will stop the normalization at this point. 

We now have a simple text file that will be used as the reference. The next step is to get the machine-generated transcripts for benchmarking.


Make hypotheses
----------------

The first release of :code:`benchmarkstt` does not integrate directly with STT vendors or engines, so transcripts for benchmarking have to be retrieved separately and converted to plain text. 

For this demo, two machine transcripts were retrieved for the Question Time audio: from AWS Transcribe and from the BBC's version of Kaldi, an open-source STT framework. This version was trained on BBC content so is expected to perform better. 

Both AWS and BBC-Kaldi return the transcript in JSON format, with word-level timings. They also contain a field with the entire transcript as a single string, and this is the value we will use (we don't benchmark timings in this version). To make the hypothesis files, simply copy the contents of the transcript field from both documents into two new text files: :code:`qt_aws_hypothesis.txt` and :code:`qt_kaldi_hypothesis.txt`.


Benchmark!
----------

We can now compare each of the hypothesis files to the reference in order to calculate the Word Error Rate. We process one file at a time, now using the main :code:`benchmarkstt` command, with two flags: :code:`--wer` is the metric to return; :code:`--diffcounts` returns the number of insertions, deletions, substitutions and correct words (the basis for WER calculation).


Calculate WER for AWS Transcribe:

.. code:: bash

  benchmarkstt --reference qt_reference.txt --hypothesis qt_aws_hypothesis.txt --wer --diffcounts


Calculate WER for BBC-Kaldi:

.. code:: bash

  benchmarkstt --reference qt_reference.txt --hypothesis qt_kaldi_hypothesis.txt --wer --diffcounts


After running these two commands, you can see that the WER for both transcripts is quite high (around 30%). Let's see the actual differences between the reference and the hypotheses by adding the :code:`--worddiffs` flag:

.. code:: bash

  benchmarkstt --reference qt_reference.txt --hypothesis qt_kaldi_hypothesis.txt --wer --diffcounts --worddiffs


Normalize
---------

You can see that a lot of the differences are due to capitalization and punctuation. Because we are only interested in the correct identification of words, these types of differences should not count as errors. To get a more accurate WER, we will remove punctuations and convert all letters to lowercase. We will do this for the reference and both hypothesis files by using the :code:`benchmarkstt-tools normalize` subcommand again, with two rules: the built-in :code:`--lowercase` shortcut rule and the :code:`--regex` rule:


.. code:: bash   

  benchmarkstt-tools normalization -i qt_reference.txt -o qt_reference_normalized.txt --lowercase --regex "[,.-]" " "

  benchmarkstt-tools normalization -i qt_kaldi_hypothesis.txt -o qt_kaldi_hypothesis_normalized.txt --lowercase --regex "[,.-]" " "

  benchmarkstt-tools normalization -i qt_aws_hypothesis.txt -o qt_aws_hypothesis_normalized.txt --lowercase --regex "[,.-]" " "

We now have normalized versions of the reference and two hypothesis files. 


Benchmark again
---------------

Let's run the :code:`benchmarkstt` command again, this time calculating WER based on the normalized files:

.. code:: bash

  benchmarkstt --reference qt_reference_normalized.txt --hypothesis qt_kaldi_hypothesis_normalized.txt --wer --diffcounts --worddiff

  benchmarkstt --reference qt_reference_normalized.txt --hypothesis qt_aws_hypothesis_normalized.txt --wer --diffcounts --worddiff

You can see that this time there are fewer differences between the reference and hypothesis. Accordingly, the WER is much lower for both hypotheses. The transcript with the lower WER is closer to the reference made from subtitles. 


Do it all in one step!
----------------------

Above, we used two ocommands: :code:`benchmarkstt-tools` for the normalization and :code:`benchmarkstt` for calculating the WER. But we can combine all these steps into a single command using config file. 

First, let's create a file for the regex normalizaiton rules. Create a text document with this content:

.. code-block:: bash

	# Replace XML tags with space
	"<[^>]+>" " "
	# Replace punctuation with space
	"[,.-]" " "

Save this file as :code:`rules.regex`.


Now let's create a config file that contains all the normalization rules. It references the regex rules file above, and also includes one of the built-in rukes:

.. code-block:: bash 

	[normalization]
	# Load regex rules file
	Regex rules.regex
	# Built in rule
	lowercase

Save the above as :code:`config.conf`. These rules will be applied to both hypothesis and reference.

Now run :code:`benchmarkstt` with the :code:`--conf` argument. We also need to tell the tool to treat the XML as plain text. We do this with the reference type argument :code:`-rt`:

.. code:: bash

	benchmarkstt qt_subs.xml -rt plaintext qt_kaldi_hypothesis.txt --config normalization.conf --wer

And again for the other transcript:


.. code:: bash

	benchmarkstt qt_subs.xml -rt plaintext qt_aws_hypothesis.txt --config normalization.conf --wer


